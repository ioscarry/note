[TOC]

# 配置集群

```bash
docker swarm init
docker swarm join-token manager
docker swarm join-token worker
# 查看集群节点
docker node ls
# 清除 swarm
docker swarm leave --force
```



设置windows10下ubuntu默认用户，之后`passwd`设置密码

`ubuntu1804 config --default-user root`

https://docs.docker.com/install/linux/linux-postinstall/#configuring-remote-access-with-systemd-unit-file



# 测试

```bash
docker network ls

docker stack ls
docker stack deploy -c docker-compose-tdapp.yml tdapp
docker stack services tdapp
docker stack ps tdapp
docker stack rm tdapp

docker logs -f --tail=1000 
docker exec  wget http://:7070

docker-compose -f docker-compose-tdapp.yml up -d
```



http://10.48.78.172:7080/

http://10.48.78.172:8080/actuator/env



Inconsistent registration IP in Eureka using docker swarm.

https://github.com/spring-cloud/spring-cloud-netflix/issues/2324



# 解决swarm下service decovery的问题

使用`docker stack deploy` 进行部署，默认是overlay，生成的容器中会有很多个网卡`ifconfig`

导致使用`prefer-ip-address: true`时获取到IP地址，注册到eureka中是错误的IP，现像是在不同容器之间可ping得通，但通过wget访问时不通

解决方式：1、搞清楚为什么那么多网卡（未搞清楚），2、设置成hostname（一通乱测试不行，最后使用了linux默认环境变量`HOSTNAME`）

```yaml
eureka:
  instance:
    hostname: ${HOSTNAME}
    instance-id: ${HOSTNAME}:${spring.application.name}:${server.port}
```

另外注意设置`spring.cloud.config.fail-fast: true`

最终效果，注册到eureka的是容器ID，各服务之间可以正常互相访问。



