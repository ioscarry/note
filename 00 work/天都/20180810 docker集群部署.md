[TOC]

> docker version 18.05.0-ce

# 镜像管理

## 使用域名

`/etc/hosts`  或 `C:\Windows\System32\drivers\etc\hosts`

```
10.48.78.172 dev.app
```

## 镜像仓库

暂不考虑安全与集群

- windows鼠标右键docker，设置daemon

- linux：` /etc/docker/daemon.json` 

```json
{
    "registry-mirrors": ["https://registry.docker-cn.com"],
    "insecure-registries" : ["http://dev.app:5000"]
}
```

```bash
# 启动私有镜像仓库
docker run -d \
  -p 5000:5000 \
  --restart always \
  --name registry \
  registry
# 标记镜像为私有仓库镜像
docker tag tdapp/tdportal dev.app:5000/tdapp/tdportal
docker push dev.app:5000/tdapp/tdportal
docker pull dev.app:5000/tdapp/tdportal
 # 查看仓库中的镜像列表
curl http://dev.app:5000/v2/_catalog
curl http://dev.app:5000/v2/{image}/tags/list
```

```
docker service create -d \
  --replicas 1 \
  --network name=tdapp_tdapp,alias=tdportal \
  -p 8080:8080 \
  --constraint 'node.role == worker' \
  -e SPRING_PROFILES_ACTIVE=dev \
  -e SPRING_CLOUD_CONFIG_ENABLED=true \
  -e SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=true \
  -e EUREKA_CLIENT_ENABLED=true \
  -e EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://10.48.78.172:7080/eureka \
  --name tdportal \
  dev.app:5000/tdapp/tdportal

docker tag tdapp/tdconfig dev.app:5000/tdapp/tdconfig
docker push dev.app:5000/tdapp/tdconfig
docker service create -d \
  --replicas 1 \
  --network tdapp_tdapp \
  --constraint 'node.role == worker' \
  --name tdconfig \
  dev.app:5000/tdapp/tdconfig
```



不同节点中容器内的网卡位置不同

>  Docker跨主机通信实现与分析 http://int32bit.me/2016/05/10/Docker%E5%AE%9E%E7%8E%B0%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1/



## 镜像版本



# 集群操作

https://docs.docker.com

## 加入与离开集群

```bash
# 创建集群，创建后当前机器即为manage节点，多个网卡时，可能需要指定IP
docker swarm init [ --advertise-addr 当前机器IP]
# 在manage节点查看加入集群的命令，注意时间同步
docker swarm join-token [worker|manager]
# 主动离开集群
docker swarm leave [--force]
```

## 节点管理

```bash
# 查看节点列表
docker node ls
# 移除节点
docker node rm [--force] NODE [NODE...]
# 移除状态为DOWN的节点
docker node ls | grep Down | awk '{print $1}' | xargs -n 1 -I ID docker node rm -f ID
# 查看某个节点运行的容器，默认查当前机器节点
docker node ps [--filter name=redis] [NODE...]
# 查看节点信息
docker node inspect --pretty self|NODE
# 节点阶级，不再是manager
docker node demote NODE
# 节点升级为manager
docker node promote NODE
```

## 添加节点的处理

新节点添加镜像仓库



为节点设置label，可以通过 --constants部署指定label的节点

## 删除节点前的准备

如何移除指定节点的实例

断路，不接受新请求，正在处理的请求继续

## 集群中部署服务栈

一堆不同的服务一起组成服务栈，若要移除某个服务所有实例：`docker service scale -d tdportal=0`

```bash
# 部署或更新服务栈
docker stack deploy [OPTIONS] STACK
# 示例：通过compose file部署服务栈
docker stack deploy --compose-file docker-compose-tdapp.yml tdapp
# 查看部署的应用，及实例数量
docker stack ls
# 查看某个服务栈中所有执行过的实例，需在manager节点使用
docker stack ps [-f name=tdapp_tdportal -f node=node01] STACK
# 查看服务栈中的服务列表，及各服务实例数量
docker stack services tdapp
# 删除服务栈
docker stack rm tdapp
```

## 集群中服务管理

`docker service`可以管理`docker stack`部署的服务

```bash
# 创建服务，docker-compose文件中各配置项与此命令中的选项对应
docker service create [OPTIONS] IMAGE
# 示例
docker service create -d \
  --replicas 2 \
  --network name=tdapp_tdapp,alias=tdportal \
  -p 8080:8080 \
  --constraint 'node.role == manager' \
  -e SPRING_PROFILES_ACTIVE=dev \
  -e SPRING_CLOUD_CONFIG_ENABLED=true \
  -e SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED=true \
  -e EUREKA_CLIENT_ENABLED=true \
  -e EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://10.48.78.172:7080/eureka \
  --name tdportal \
  tdapp/tdportal
# 查看服务列表
docker service ls
# 查看指定服务信息
docker service inspect --pretty tdportal
# 查看指定服务实例信息
docker service ps tdportal
# 删除指定服务
docker service rm tdportal
# 将服务规模化，即控制服务实例数量，可增加，也可减少
docker service scale -d tdportal=2
docker service scale tdportal=2
# 更新服务，参数与create差不多
docker service update [OPTIONS] SERVICE
# 示例
docker service update --constraint-rm 'node.role == manager' tdportal
docker service update --constraint-add 'node.role == worker' tdportal
# 恢复最近一次update的修改
docker service rollback SERVICE
# 查看服务日志，显示所有实例的日志，当logging driver为json-file或journald时有效
docker service logs 服务ID或服务名称
# 查看每个实例最后100行日志 
docker service logs --tail 100 tdportal
docker service logs --since 2018-08-10Z --tail 100 tdportal
docker service logs -f --since 2018-08-10T06:30Z --tail 100 tdportal
```

# 日志检索

https://docs.docker.com/config/containers/logging/configure/

docker klv

# 服务监控



# 链路跟踪

